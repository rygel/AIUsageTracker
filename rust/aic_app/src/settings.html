<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - AI Consumption Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #1E1E1E;
            --bg-medium: #252526;
            --bg-light: #2D2D30;
            --border-color: #333333;
            --text-primary: #FFFFFF;
            --text-secondary: #AAAAAA;
            --accent-blue: #007ACC;
            --accent-green: #00FF85;
            --accent-red: #FF1744;
            --accent-yellow: #FFD600;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }

        .settings-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            border: 1px solid var(--border-color);
        }

        .settings-header {
            background: var(--bg-medium);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            -webkit-app-region: drag;
            app-region: drag;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            -webkit-app-region: no-drag;
            app-region: no-drag;
        }

        .header-icon {
            color: var(--accent-blue);
            font-size: 20px;
        }

        .header-text {
            font-size: 18px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            -webkit-app-region: no-drag;
            app-region: no-drag;
        }

        .header-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            border-radius: 3px;
            -webkit-app-region: no-drag;
            app-region: no-drag;
            transition: all 0.2s;
        }

        .header-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .header-btn.active {
            color: #FFD700;
            /* Gold color for privacy mode */
            background: rgba(255, 215, 0, 0.1);
        }
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            -webkit-app-region: no-drag;
            app-region: no-drag;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        .tab-container {
            display: flex;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-light);
        }

        .tab.active {
            color: var(--text-primary);
            background: var(--bg-dark);
            border-bottom-color: var(--accent-blue);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .provider-card {
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .provider-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .provider-icon {
            width: 24px;
            height: 24px;
            background: var(--accent-blue);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .provider-name {
            font-size: 13px;
            font-weight: 500;
        }

        .provider-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .provider-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            gap: 8px;
        }

        .provider-api-input {
            flex: 1;
        }

        .provider-api-input .form-input {
            padding: 4px 8px;
            font-size: 12px;
        }

        .auth-source-label {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--bg-dark);
            border-radius: 3px;
            white-space: nowrap;
        }

        .api-key-input {
            flex: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 3px;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .checkbox-label input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--accent-blue);
        }

        .status-badge {
            font-size: 11px;
            padding: 3px 8px;
            background: #555;
            color: #888;
            border-radius: 3px;
        }

        .status-badge.active {
            background: var(--accent-green);
            color: #000;
        }

        .status-badge.inactive {
            background: #444;
            color: #888;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 3px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-select {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 3px;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn {
            background: #444;
            border: none;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            transition: background 0.15s;
        }

        .btn:hover {
            background: #555;
        }

        .btn-primary {
            background: var(--accent-blue);
        }

        .btn-primary:hover {
            background: #009DFF;
        }

        .btn-success {
            background: var(--accent-green);
            color: #000;
        }

        .btn-success:hover {
            background: #00E676;
        }

        .btn-danger {
            background: var(--accent-red);
        }

        .btn-danger:hover {
            background: #FF5252;
        }

        .settings-section {
            margin-bottom: 28px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .settings-label {
            min-width: 160px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .settings-control {
            flex: 1;
            max-width: 300px;
        }

        .settings-footer {
            background: var(--bg-medium);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border-color);
        }

        .footer-actions {
            display: flex;
            gap: 10px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            width: 450px;
            padding: 24px;
            border-radius: 6px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .auth-dialog {
            text-align: center;
            padding: 10px;
        }

        .auth-code {
            background: var(--bg-light);
            padding: 15px 30px;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 6px;
            margin: 20px 0;
            font-family: monospace;
            border-radius: 4px;
        }

        .auth-link {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .update-status {
            padding: 20px;
            text-align: center;
            background: var(--bg-light);
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .update-version {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .update-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .about-section {
            text-align: center;
            padding: 20px;
        }

        .about-logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border-radius: 12px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .about-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .about-version {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .about-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .about-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 13px;
        }

        .about-link:hover {
            text-decoration: underline;
        }

        .about-license {
            font-size: 12px;
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .font-preview {
            padding: 16px;
            background: var(--bg-light);
            border-radius: 4px;
            margin-top: 12px;
            text-align: center;
        }

        .font-preview-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* History Subtabs */
        .btn-small {
            padding: 4px 10px;
            font-size: 11px;
            background: #333;
            color: #888;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-small.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .history-table th,
        .history-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #333;
        }

        .history-table th {
            color: var(--text-primary);
            font-weight: 600;
            background: #252525;
            position: sticky;
            top: 0;
        }

        .history-table tr:hover {
            background: #2a2a2a;
        }

        .log-body {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
            background: #1e1e1e;
            padding: 5px;
            border-radius: 3px;
        }

        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }

        /* Dark scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 0;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
            border: 2px solid #1e1e1e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }

        ::-webkit-scrollbar-corner {
            background: #1e1e1e;
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #424242 #1e1e1e;
        }
    </style>
</head>

<body>
    <div class="settings-container">
        <div class="settings-header" data-tauri-drag-region>
            <div class="header-title">
                <span class="header-icon">&#9881;</span>
                <span class="header-text">Settings</span>
            </div>
            <div class="header-right">
                <button class="header-btn" id="privacyToggleBtn" title="Toggle Privacy Mode"
                    onclick="console.log('Inline click!'); togglePrivacyMode(); return false;">ðŸ”’</button>
                <button class="close-btn" id="closeBtn">&#215;</button>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab active" data-tab="providers">Providers</button>
            <button class="tab" data-tab="layout">Layout</button>
            <button class="tab" data-tab="updates">Updates</button>
            <button class="tab" data-tab="history">History</button>
            <button class="tab" data-tab="fonts">Fonts</button>
            <button class="tab" data-tab="agent">Agent</button>
        </div>

        <div class="settings-content">
            <div class="tab-panel active" id="providers-panel">
                <div id="providers-list">
                    <div class="loading">Loading providers...</div>
                </div>
            </div>

            <div class="tab-panel" id="layout-panel">
                <div class="settings-section">
                    <div class="settings-section-title">Window</div>
                    <div class="settings-row">
                        <label class="settings-label">Compact Mode</label>
                        <div class="settings-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="compactMode">
                                <span>Enable compact view</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Always on Top</label>
                        <div class="settings-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="alwaysOnTop">
                                <span>Keep window always visible</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Stay Open</label>
                        <div class="settings-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="stayOpen">
                                <span>Keep window open after focus loss</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Show All</label>
                        <div class="settings-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showAll">
                                <span>Show inactive providers</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Auto-Refresh</label>
                        <div class="settings-control" style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="form-input" id="refreshInterval" min="10" max="3600" value="300"
                                style="width: 80px;">
                            <span style="font-size: 12px; color: var(--text-secondary);">seconds</span>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="settings-section">
                    <div class="settings-section-title">UI Colors</div>
                    <div class="settings-row">
                        <label class="settings-label">Yellow Threshold (%)</label>
                        <input type="number" class="form-input settings-control" id="yellowThreshold" value="60" min="0"
                            max="100">
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Red Threshold (%)</label>
                        <input type="number" class="form-input settings-control" id="redThreshold" value="80" min="0"
                            max="100">
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" style="flex: 1;">
                            <input type="checkbox" id="invertProgressBar" style="margin-right: 8px;">
                            Invert Progress Bars (Show 'Remaining' instead of 'Used')
                        </label>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="updates-panel">
                <div class="settings-section">
                    <div class="settings-section-title">Application Updates</div>
                    <div class="update-status" id="updateStatus">
                        <div class="update-version" id="currentVersion">v</div>
                        <div class="update-message" id="updateMessage">Checking for updates...</div>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Auto-Update</label>
                        <div class="settings-control">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoUpdate">
                                <span>Automatically check for updates</span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="checkUpdatesBtn" onclick="checkForUpdates()">Check for
                        Updates</button>
                </div>
            </div>

            <div class="tab-panel" id="history-panel">
                <div class="settings-section">
                    <div class="settings-section-title"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Historical Data & Logs</span>
                        <div class="history-subtabs" style="display: flex; gap: 10px;">
                            <button class="btn-small active" onclick="switchHistorySubTab('usage')"
                                id="usage-subtab-btn">Usage</button>
                            <button class="btn-small" onclick="switchHistorySubTab('logs')" id="logs-subtab-btn">Raw
                                Logs</button>
                        </div>
                    </div>

                    <div id="usage-history-subpanel">
                        <div id="history-list">
                            <div class="loading">Loading history...</div>
                        </div>
                    </div>

                    <div id="logs-history-subpanel" style="display: none;">
                        <div id="logs-list">
                            <div class="loading">Loading raw logs...</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button class="btn" onclick="refreshHistory()">Refresh History</button>
                </div>
            </div>

            <div class="tab-panel" id="fonts-panel">
                <div class="settings-section">
                    <div class="settings-section-title">Typography</div>
                    <div class="settings-row">
                        <label class="settings-label">Font Family</label>
                        <select class="form-input settings-control" id="fontFamily">
                            <option value="-apple-system">System Default</option>
                            <option value="Segoe UI">Segoe UI</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Inter">Inter</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Font Size</label>
                        <input type="number" class="form-input settings-control" id="fontSize" value="13" min="8"
                            max="24">
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">Style</label>
                        <div class="settings-control">
                            <label class="checkbox-label" style="margin-right: 20px;">
                                <input type="checkbox" id="fontBold">
                                <span>Bold</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="fontItalic">
                                <span>Italic</span>
                            </label>
                        </div>
                    </div>
                    <div class="font-preview">
                        <div class="font-preview-text" id="fontPreviewText"
                            style="font-weight: normal; font-style: normal;">
                            The quick brown fox jumps over the lazy dog
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            Preview Text - 1234567890
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <button class="btn" id="resetFontBtn" onclick="resetFontSettings()">Reset to Default</button>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="agent-panel">
                <div class="settings-section">
                    <div class="settings-section-title">Agent Control</div>
                    <div class="settings-row">
                        <label class="settings-label">Agent Status</label>
                        <div class="settings-control">
                            <span id="agentStatusText" style="color: var(--text-secondary);">Checking...</span>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="startAgentBtn" onclick="startAgent()"
                            style="display: none;">Start Agent</button>
                        <button class="btn" id="stopAgentBtn" onclick="stopAgent()"
                            style="display: none; background: var(--accent-red); color: white;">Stop Agent</button>
                    </div>
                </div>

                <div class="settings-section" style="margin-top: 24px;">
                    <div class="settings-section-title">Token Discovery</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                        Automatically discover API tokens from common locations on your system via the agent.
                    </p>
                    <button class="btn" id="discoverTokenBtn" onclick="discoverTokens()">Discover Tokens</button>
                    <div id="discoveryStatus" style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                    </div>
                </div>

                <div class="settings-section" style="margin-top: 24px;">
                    <div class="settings-section-title">Agent Information</div>
                    <div class="settings-row">
                        <label class="settings-label">Version</label>
                        <div class="settings-control">
                            <span id="aboutVersion">Version </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-footer">
            <div class="footer-actions">
                <button class="btn btn-primary" id="saveBtn" onclick="saveSettings()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Authentication</span>
                <button class="close-btn" onclick="closeAuthModal()">&#215;</button>
            </div>
            <div class="auth-dialog" id="authContent">
                <p>Initializing...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('=== SETTINGS.HTML SCRIPT START ===');

        let configs = [];
        let usageData = [];  // Store usage data to get antigravity details
        let prefs = {};
        let settingsChanged = false;

        // GitHub auth status from agent
        let githubAuthStatus = { is_authenticated: false, username: '' };

        async function getAgentPort() {
            // Try to read port from .agent_port file
            try {
                const response = await fetch('http://localhost:8080/health');
                // If we get here, port is 8080
                return 8080;
            } catch (e) {
                // Port 8080 not available, try another common port
                for (let p = 8081; p <= 8100; p++) {
                    try {
                        await fetch(`http://localhost:${p}/health`);
                        return p;
                    } catch (e2) {
                        // Continue trying
                    }
                }
                return 8080; // Fallback
            }
        }

        async function fetchGitHubAuthStatus() {
            try {
                const port = await getAgentPort();
                const response = await fetch(`http://localhost:${port}/api/auth/github/status`);
                if (response.ok) {
                    githubAuthStatus = await response.json();
                    console.log('GitHub auth status:', githubAuthStatus);
                }
            } catch (e) {
                console.error('Failed to fetch GitHub auth status:', e);
                githubAuthStatus = { is_authenticated: false, username: '' };
            }
        }

        // Privacy mode state
        let privacyMode = false;

        async function togglePrivacyMode() {
            console.log('togglePrivacyMode called, current state:', privacyMode);
            privacyMode = !privacyMode;
            console.log('New privacy mode state:', privacyMode);

            const btn = document.getElementById('privacyToggleBtn');
            if (btn) {
                btn.classList.toggle('active', privacyMode);
                btn.title = privacyMode ? 'Privacy Mode On (Click to Show)' : 'Privacy Mode Off (Click to Hide)';
            }

            // Apply privacy mode to all API key inputs
            console.log('Applying privacy mode to inputs...');
            applyPrivacyMode();

            // Emit event to sync with other windows
            if (window.__TAURI__?.event) {
                try {
                    await window.__TAURI__.event.emit('privacy-mode-changed', { enabled: privacyMode });
                } catch (e) {
                    console.error('Failed to emit privacy mode event:', e);
                }
            }

            // Save to localStorage
            try {
                localStorage.setItem('privacy_mode', JSON.stringify(privacyMode));
            } catch (e) {
                console.warn('Could not save privacy mode:', e);
            }
        }

        function applyPrivacyMode() {
            console.log('applyPrivacyMode called, privacyMode:', privacyMode);
            const apiKeyInputs = document.querySelectorAll('.api-key-input');
            console.log('Found', apiKeyInputs.length, 'API key inputs');
            apiKeyInputs.forEach((input, index) => {
                console.log(`Processing input ${index}:`, input.id, 'current type:', input.type, 'value length:', input.value?.length || 0);
                try {
                    if (privacyMode) {
                        input.type = 'password';
                        console.log(`  Changed to password successfully`);
                    } else {
                        input.type = 'text';
                        console.log(`  Changed to text successfully`);
                    }
                } catch (err) {
                    console.error(`  ERROR changing input type:`, err);
                }
            });
        }

        function loadPrivacyMode() {
            try {
                const saved = localStorage.getItem('privacy_mode');
                if (saved !== null) {
                    privacyMode = JSON.parse(saved);
                    const btn = document.getElementById('privacyToggleBtn');
                    if (btn) {
                        btn.classList.toggle('active', privacyMode);
                        btn.title = privacyMode ? 'Privacy Mode On (Click to Show)' : 'Privacy Mode Off (Click to Hide)';
                    }
                    applyPrivacyMode();
                }
            } catch (e) {
                console.warn('Could not load privacy mode:', e);
            }
        }

        function setupPrivacyModeListener() {
            if (window.__TAURI__?.event) {
                window.__TAURI__.event.listen('privacy-mode-changed', (event) => {
                    console.log('Settings received privacy mode change:', event);
                    const newPrivacyMode = event.payload?.enabled ?? false;
                    if (newPrivacyMode !== privacyMode) {
                        privacyMode = newPrivacyMode;
                        const btn = document.getElementById('privacyToggleBtn');
                        if (btn) {
                            btn.classList.toggle('active', privacyMode);
                            btn.title = privacyMode ? 'Privacy Mode On (Click to Show)' : 'Privacy Mode Off (Click to Hide)';
                        }
                        applyPrivacyMode();

                        // Save to localStorage to keep in sync
                        try {
                            localStorage.setItem('privacy_mode', JSON.stringify(privacyMode));
                        } catch (e) {
                            console.warn('Could not save privacy mode:', e);
                        }
                    }
                });
            }
        }

        console.log('window.__TAURI__ available:', typeof window.__TAURI__ !== 'undefined');
        console.log('window.__TAURI__:', window.__TAURI__);

        const invoke = window.__TAURI__?.invoke || window.__TAURI__?.core?.invoke;
        console.log('invoke function available:', !!invoke);

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== DOMContentLoaded EVENT FIRED ===');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            document.getElementById('closeBtn').addEventListener('click', closeSettings);

            document.querySelectorAll('.form-input, .form-select, input[type="checkbox"]').forEach(el => {
                el.addEventListener('change', () => settingsChanged = true);
                el.addEventListener('input', () => settingsChanged = true);
            });

            document.getElementById('fontBold').addEventListener('change', updateFontPreview);
            document.getElementById('fontItalic').addEventListener('change', updateFontPreview);
            document.getElementById('fontFamily').addEventListener('change', updateFontPreview);
            document.getElementById('fontSize').addEventListener('input', updateFontPreview);

            // Always on Top checkbox - apply immediately
            document.getElementById('alwaysOnTop').addEventListener('change', async (e) => {
                console.log('Always on Top checkbox changed:', e.target.checked);
                if (invoke) {
                    try {
                        await invoke('toggle_always_on_top', { enabled: e.target.checked });
                        console.log('Always on Top toggled successfully');
                    } catch (err) {
                        console.error('Failed to toggle always on top:', err);
                    }
                }
            });

            // Setup privacy mode listener for cross-window sync
            setupPrivacyModeListener();

            // Load saved privacy mode
            loadPrivacyMode();

            console.log('Settings initialized, privacy button has inline onclick handler');

            await loadSettings();
            await loadAppVersion();
            updateFontPreview();
        });

        // Listen for when the settings window is shown (re-opened)
        console.log('Checking Tauri event API...');
        console.log('window.__TAURI__:', window.__TAURI__);
        console.log('window.__TAURI__?.event:', window.__TAURI__?.event);

        if (window.__TAURI__?.event) {
            console.log('Setting up event listeners...');
            try {
                // Listen for when settings window is shown (re-opened)
                const unlistenSettings = window.__TAURI__.event.listen('settings-window-shown', async (event) => {
                    console.log('=== Settings window shown event received ===', event);
                    console.log('Reloading data...');
                    await loadSettings();
                    await loadAppVersion();
                });
                console.log('Settings event listener registered');

                // Listen for when agent becomes ready
                const unlistenAgent = window.__TAURI__.event.listen('agent-ready', async (event) => {
                    console.log('=== Agent ready event received ===', event);
                    console.log('Agent is ready, reloading providers...');
                    await loadSettings();
                    await loadAppVersion();
                });
                console.log('Agent-ready event listener registered');
            } catch (err) {
                console.error('Failed to register event listener:', err);
            }
        } else {
            console.error('Tauri event API not available');
            console.error('Available on window.__TAURI__:', Object.keys(window.__TAURI__ || {}));
        }

        // Add F12 key to open DevTools for debugging
        document.addEventListener('keydown', async (e) => {
            if (e.key === 'F12') {
                console.log('F12 pressed - attempting to open DevTools');
                try {
                    // Tauri v2 API: Use invoke to open DevTools
                    if (window.__TAURI__?.core?.invoke) {
                        await window.__TAURI__.core.invoke('open_devtools');
                        console.log('DevTools opened via invoke');
                    } else if (window.__TAURI__?.invoke) {
                        await window.__TAURI__.invoke('open_devtools');
                        console.log('DevTools opened via invoke');
                    } else {
                        console.warn('Tauri invoke not available for DevTools');
                    }
                } catch (err) {
                    console.error('Failed to open DevTools:', err);
                }
            }
        });

        // Add Escape key to close settings window
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                console.log('Escape pressed - closing settings window');
                closeSettings();
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');

            if (tabName === 'history') {
                refreshHistory();
            }
        }

        let currentHistorySubTab = 'usage';
        function switchHistorySubTab(subTab) {
            currentHistorySubTab = subTab;
            document.getElementById('usage-subtab-btn').classList.toggle('active', subTab === 'usage');
            document.getElementById('logs-subtab-btn').classList.toggle('active', subTab === 'logs');

            document.getElementById('usage-history-subpanel').style.display = subTab === 'usage' ? 'block' : 'none';
            document.getElementById('logs-history-subpanel').style.display = subTab === 'logs' ? 'block' : 'none';

            refreshHistory();
        }

        async function refreshHistory() {
            if (currentHistorySubTab === 'usage') {
                await loadUsageHistory();
            } else {
                await loadRawLogs();
            }
        }

        async function loadUsageHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '<div class="loading">Loading usage history...</div>';

            try {
                const history = await invoke('get_historical_usage_from_agent', { limit: 50 });
                if (!history || history.length === 0) {
                    container.innerHTML = '<div class="loading">No history found.</div>';
                    return;
                }

                let html = `<table class="history-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Provider</th>
                            <th>Usage</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>`;

                history.forEach(item => {
                    const date = new Date(item.timestamp).toLocaleString();
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${item.provider_name}</td>
                            <td>${item.usage.toFixed(2)}</td>
                            <td>${item.usage_unit}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) {
                console.error('Failed to load history:', e);
                container.innerHTML = `<div class="error">Failed to load history: ${e}</div>`;
            }
        }

        async function loadRawLogs() {
            const container = document.getElementById('logs-list');
            container.innerHTML = '<div class="loading">Loading debug logs...</div>';

            try {
                const logs = await invoke('get_raw_responses_from_agent', { limit: 20 });
                if (!logs || logs.length === 0) {
                    container.innerHTML = '<div class="loading">No logs found. (Retention: 24h)</div>';
                    return;
                }

                let html = `<table class="history-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Provider</th>
                            <th>Response Body</th>
                        </tr>
                    </thead>
                    <tbody>`;

                logs.forEach(log => {
                    const date = new Date(log.timestamp * 1000).toLocaleString();
                    html += `
                        <tr>
                            <td style="white-space: nowrap;">${date}</td>
                            <td style="white-space: nowrap;">${log.provider_id}</td>
                            <td><div class="log-body">${escapeHtml(log.response_body)}</div></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) {
                console.error('Failed to load logs:', e);
                container.innerHTML = `<div class="error">Failed to load logs: ${e}</div>`;
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function loadSettings() {
            console.log('=== loadSettings() START ===');
            console.log('Timestamp:', new Date().toISOString());
            try {
                // First try to get preloaded data
                console.log('Checking for preloaded data...');
                let dataLoaded = false;

                if (invoke) {
                    try {
                        const startTime = Date.now();
                        const preloaded = await invoke('get_preloaded_settings_data');
                        const elapsed = Date.now() - startTime;
                        console.log(`Preloaded data check completed in ${elapsed}ms`);

                        if (preloaded) {
                            console.log('Using preloaded data!');
                            configs = preloaded[0] || [];
                            usageData = preloaded[1] || [];
                            console.log('Preloaded configs:', configs.length, 'providers');
                            console.log('Preloaded usage:', usageData?.length || 0, 'providers');
                            dataLoaded = true;
                        } else {
                            console.log('No preloaded data available, will fetch from agent');
                        }
                    } catch (preloadErr) {
                        console.log('Could not get preloaded data:', preloadErr.message || preloadErr);
                    }
                }

                // If no preloaded data, fetch from agent
                if (!dataLoaded && invoke) {
                    console.log('Loading providers from agent...');
                    console.log('Starting timer...');
                    const startTime = Date.now();

                    try {
                        console.log('Invoking get_all_providers_from_agent NOW...');
                        const agentProviders = await invoke('get_all_providers_from_agent');
                        const elapsed = Date.now() - startTime;
                        console.log(`Call completed in ${elapsed}ms`);
                        console.log('Raw response from agent:', agentProviders);
                        console.log('Response type:', typeof agentProviders);
                        console.log('Is array:', Array.isArray(agentProviders));

                        if (Array.isArray(agentProviders)) {
                            console.log('Array length:', agentProviders.length);
                            if (agentProviders.length > 0) {
                                console.log('First provider:', JSON.stringify(agentProviders[0], null, 2));
                            }
                        }
                        configs = agentProviders || [];
                        console.log('Configs assigned:', configs.length, 'providers');

                        // Also fetch usage data to get antigravity details
                        try {
                            console.log('Fetching usage data for antigravity details...');
                            usageData = await invoke('get_usage');
                            console.log('Usage data loaded:', usageData?.length || 0, 'providers');
                        } catch (usageErr) {
                            console.log('Could not fetch usage data:', usageErr.message || usageErr);
                            usageData = [];
                        }
                    } catch (agentErr) {
                        const elapsed = Date.now() - startTime;
                        console.error(`ERROR after ${elapsed}ms calling get_all_providers_from_agent:`, agentErr);
                        console.error('Error name:', agentErr.name);
                        console.error('Error message:', agentErr.message);
                        console.error('Error stack:', agentErr.stack);
                        configs = [];
                    }
                } else if (!invoke) {
                    console.error('invoke is not available!');
                }

                // Load preferences (always from local - UI-specific settings)
                console.log('Loading preferences...');
                if (invoke) {
                    try {
                        const startTime = Date.now();
                        prefs = await invoke('load_preferences');
                        console.log(`Preferences loaded in ${Date.now() - startTime}ms:`, prefs);
                    } catch (e) {
                        console.log('No preferences found:', e.message || e);
                    }


                }

                console.log('Calling populateProviders() with', configs.length, 'configs');
                populateProviders();
                console.log('Calling populateLayout()');
                populateLayout();
                console.log('Calling populateFonts()');
                populateFonts();
                console.log('Checking agent status...');
                await checkAgentStatus();

                // Fetch GitHub auth status
                await fetchGitHubAuthStatus();

                console.log('=== loadSettings() END ===');
            } catch (e) {
                console.error('CRITICAL ERROR in loadSettings:', e);
                console.error('Error name:', e.name);
                console.error('Error message:', e.message);
                console.error('Error stack:', e.stack);
            }
        }

        async function loadAppVersion() {
            try {
                const version = await invoke('get_app_version');
                const currentVersionEl = document.getElementById('currentVersion');
                const aboutVersionEl = document.getElementById('aboutVersion');
                if (version) {
                    if (currentVersionEl) currentVersionEl.textContent = 'v' + version;
                    if (aboutVersionEl) aboutVersionEl.textContent = 'Version ' + version;
                }
            } catch (e) {
                console.log('Could not load app version:', e);
            }
        }

        // Agent control functions
        async function checkAgentStatus() {
            try {
                const isRunning = await invoke('is_agent_running_http');
                const statusText = document.getElementById('agentStatusText');
                const startBtn = document.getElementById('startAgentBtn');
                const stopBtn = document.getElementById('stopAgentBtn');

                if (isRunning) {
                    if (statusText) statusText.textContent = 'Running';
                    if (statusText) statusText.style.color = 'var(--accent-green)';
                    if (startBtn) startBtn.style.display = 'none';
                    if (stopBtn) stopBtn.style.display = 'inline-block';
                } else {
                    if (statusText) statusText.textContent = 'Stopped';
                    if (statusText) statusText.style.color = 'var(--text-secondary)';
                    if (startBtn) startBtn.style.display = 'inline-block';
                    if (stopBtn) stopBtn.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to check agent status:', e);
                const statusText = document.getElementById('agentStatusText');
                if (statusText) {
                    statusText.textContent = 'Error';
                    statusText.style.color = 'var(--accent-red)';
                }
            }
        }

        async function startAgent() {
            console.log('Starting agent from settings...');
            try {
                const success = await invoke('start_agent');
                if (success) {
                    console.log('Agent started successfully');
                    await checkAgentStatus();
                    // Reload data after agent starts
                    setTimeout(() => loadSettings(), 2000);
                }
            } catch (e) {
                console.error('Failed to start agent:', e);
                alert('Failed to start agent: ' + (e?.message || e));
            }
        }

        async function stopAgent() {
            console.log('Stopping agent from settings...');
            try {
                const success = await invoke('stop_agent');
                if (success) {
                    console.log('Agent stopped successfully');
                    await checkAgentStatus();
                }
            } catch (e) {
                console.error('Failed to stop agent:', e);
                alert('Failed to stop agent: ' + (e?.message || e));
            }
        }

        async function discoverTokens() {
            console.log('Discovering tokens via agent...');
            const statusDiv = document.getElementById('discoveryStatus');
            const btn = document.getElementById('discoverTokenBtn');

            if (statusDiv) statusDiv.textContent = 'Discovering tokens...';
            if (btn) btn.disabled = true;

            try {
                // Call the agent's discover endpoint
                const port = await getAgentPort();
                const response = await fetch(`http://localhost:${port}/api/discover`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Token discovery result:', result);

                    if (result.discovered && result.discovered.length > 0) {
                        if (statusDiv) statusDiv.textContent = `Discovered ${result.discovered.length} token(s). Reloading providers...`;
                        // Reload settings to show newly discovered providers
                        setTimeout(() => loadSettings(), 1000);
                    } else {
                        if (statusDiv) statusDiv.textContent = 'No new tokens found.';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Discovery failed:', errorText);
                    if (statusDiv) statusDiv.textContent = 'Discovery failed. Is the agent running?';
                }
            } catch (e) {
                console.error('Failed to discover tokens:', e);
                if (statusDiv) statusDiv.textContent = 'Error: ' + (e?.message || 'Failed to connect to agent');
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function populateProviders() {
            console.log('=== populateProviders() START ===');
            console.log('configs.length:', configs ? configs.length : 'undefined');

            const container = document.getElementById('providers-list');
            console.log('Container element:', container);

            if (!container) {
                console.error('ERROR: providers-list container not found!');
                return;
            }

            if (!configs || configs.length === 0) {
                console.warn('WARNING: No configs to display');
                container.innerHTML = '<div class="error">No providers found. Make sure the agent is running.</div>';
                return;
            }

            const providerInfo = {
                'github-copilot': { name: 'GitHub Copilot', icon: 'G', color: '#24292e' },
                'openai': { name: 'OpenAI', icon: 'O', color: '#10a37f' },
                'claude-code': { name: 'Claude Code', icon: 'C', color: '#d4a574' },
                'deepseek': { name: 'DeepSeek', icon: 'D', color: '#1e80ff' },
                'gemini-cli': { name: 'Google Gemini', icon: 'G', color: '#4285f4' },
                'kimi': { name: 'Kimi', icon: 'K', color: '#0066cc' },
                'minimax': { name: 'MiniMax', icon: 'M', color: '#FF6B35' },
                'xiaomi': { name: 'Xiaomi', icon: 'X', color: '#FF6900' },
                'antigravity': { name: 'Antigravity', icon: 'A', color: '#8B5CF6' },
                'openrouter': { name: 'OpenRouter', icon: 'R', color: '#10B981' },
                'zai': { name: 'Z.ai', icon: 'Z', color: '#3B82F6' },
                'zai-coding-plan': { name: 'Z.ai Coding', icon: 'Z', color: '#2563EB' },
                'mistral': { name: 'Mistral', icon: 'M', color: '#F97316' },
                'opencode-zen': { name: 'OpenCode', icon: 'C', color: '#EC4899' },
                'synthetic': { name: 'Synthetic', icon: 'S', color: '#14B8A6' }
            };

            console.log('Generating HTML for', configs.length, 'providers...');
            console.log('Provider IDs before sorting:', configs.map(c => c.provider_id).join(', '));

            // Sort configs alphabetically by provider name
            configs.sort((a, b) => {
                const infoA = providerInfo[a.provider_id] || { name: a.provider_id };
                const infoB = providerInfo[b.provider_id] || { name: b.provider_id };
                return infoA.name.localeCompare(infoB.name);
            });

            console.log('Provider IDs after sorting:', configs.map(c => c.provider_id).join(', '));

            const html = configs.map((config, index) => {
                console.log(`Processing provider ${index}:`, config.provider_id, '- Has key:', !!(config.api_key && config.api_key.length > 0), '- Auth source:', config.auth_source);
                const info = providerInfo[config.provider_id] || { name: config.provider_id, icon: config.provider_id.charAt(0).toUpperCase(), color: '#007ACC' };
                const hasKey = config.api_key && config.api_key.length > 0;

                // Build display name with account name for providers that have it (e.g., GitHub Copilot)
                let displayName = info.name;
                // Get account_name from usage data for GitHub Copilot (and other providers that have it)
                let accountName = '';
                if (config.provider_id === 'github-copilot') {
                    // Use username from agent's auth service (primary source)
                    accountName = githubAuthStatus.username || '';
                    if (accountName) {
                        const maskedName = privacyMode ? '***' : accountName;
                        displayName = info.name + ' [' + maskedName + ']';
                    }
                } else {
                    const usage = usageData.find(u => u.provider_id === config.provider_id);
                    accountName = usage?.account_name || config.account_name || '';
                    if (accountName && config.provider_id !== 'github-copilot') {
                        const maskedName = privacyMode ? '***' : accountName;
                        displayName = info.name + ' [' + maskedName + ']';
                    }
                }

                console.log(`  -> Using display name: ${displayName}, icon: ${info.icon}`);

                // Format auth source for display - use short names for UI
                let authSourceDisplay = config.auth_source || 'None';
                if (authSourceDisplay === 'Environment Variable') authSourceDisplay = 'Env';
                else if (authSourceDisplay === 'Environment') authSourceDisplay = 'Env';
                else if (authSourceDisplay === 'AI Consumption Tracker') authSourceDisplay = 'AICT';
                // Kilo Code and OpenCode stay as is

                // Check if this is antigravity and has usage data with details
                let subModelsHtml = '';
                if (config.provider_id === 'antigravity') {
                    const usage = usageData.find(u => u.provider_id === 'antigravity');
                    if (usage && usage.details && usage.details.length > 0) {
                        subModelsHtml = `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #3a3a3a;">
                                <div style="font-size: 11px; color: #888; font-weight: 600; margin-bottom: 8px;">Individual Quota Icons:</div>
                                ${usage.details.map(detail => `
                                    <label class="checkbox-label" style="display: block; margin: 4px 0; margin-left: 10px; font-size: 11px;">
                                        <input type="checkbox" class="subtray-checkbox" data-provider="${config.provider_id}" data-detail="${detail.name}" ${config.enabled_sub_trays && config.enabled_sub_trays.includes(detail.name) ? 'checked' : ''}>
                                        <span style="color: #ccc;">${detail.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                    }
                }

                return `
                    <div class="provider-card" data-provider="${config.provider_id}">
                        <div class="provider-header">
                            <div class="provider-info">
                                <div class="provider-icon" style="background: ${info.color};">${info.icon}</div>
                                <span class="provider-name">${displayName}</span>
                            </div>
                            <div class="provider-actions">
                                <span class="auth-source-label" title="Configuration Source: ${config.auth_source || 'None'}">${authSourceDisplay}</span>
                                <label class="checkbox-label">
                                    <input type="checkbox" class="tray-checkbox" ${config.show_in_tray ? 'checked' : ''}>
                                    <span>Tray</span>
                                </label>
                                <span class="status-badge ${hasKey ? 'active' : 'inactive'}">${hasKey ? 'Active' : 'Inactive'}</span>
                            </div>
                        </div>
                        ${config.provider_id === 'github-copilot' ? `
                            <div class="provider-row" style="display: flex; align-items: center; gap: 10px;">
                                ${(() => {
                            // Get account_name from usage data (not from config)
                            const usage = usageData.find(u => u.provider_id === 'github-copilot');
                            const usageAccountName = usage?.account_name || '';
                            // Use username from agent's auth service (primary source)
                            const username = githubAuthStatus.username || usageAccountName;
                            const isAuthenticated = githubAuthStatus.is_authenticated;
                            const displayUsername = (privacyMode && username) ? '***' : username;
                            const authStatus = isAuthenticated
                                ? (username ? `Authenticated (${displayUsername})` : 'Authenticated')
                                : 'Not Authenticated';
                            const authColor = isAuthenticated ? '#90EE90' : '#888';
                            const btnText = isAuthenticated ? 'Log out' : 'Log in';
                            return `
                                        <span style="color: ${authColor}; font-size: 11px;">${authStatus}</span>
                                        <button class="auth-btn" data-provider="github-copilot"
                                            style="padding: 4px 12px; font-size: 11px; background: #333; color: #fff; border: 1px solid #555; border-radius: 3px; cursor: pointer;">
                                            ${btnText}
                                        </button>
                                    `;
                        })()}
                            </div>
                        ` : `
                            <div class="provider-row">
                                <input type="text" class="api-key-input" id="api-key-${config.provider_id}"
                                    value="${config.api_key || ''}" 
                                    placeholder="Enter API key"
                                    data-provider="${config.provider_id}">
                            </div>
                        `}
                        ${subModelsHtml}
                    </div>
                `;
            }).join('');

            console.log('Setting container innerHTML...');
            container.innerHTML = html;
            console.log('Container HTML set, length:', html.length);

            // Apply privacy mode to newly created API key inputs
            console.log('Calling applyPrivacyMode after populating providers, privacyMode:', privacyMode);
            applyPrivacyMode();

            // Verify the inputs were created
            const verifyInputs = document.querySelectorAll('.api-key-input');
            console.log('Verified', verifyInputs.length, 'API key inputs exist after population');

            document.querySelectorAll('.tray-checkbox').forEach(el => {
                el.addEventListener('change', () => settingsChanged = true);
            });

            document.querySelectorAll('.api-key-input').forEach(el => {
                el.addEventListener('input', () => settingsChanged = true);
            });

            // Add GitHub auth button listeners
            document.querySelectorAll('.auth-btn').forEach(el => {
                el.addEventListener('click', async (e) => {
                    const providerId = e.target.dataset.provider;
                    if (providerId === 'github-copilot') {
                        const config = configs.find(c => c.provider_id === 'github-copilot');
                        const isAuthenticated = config && config.api_key && config.api_key.length > 0;

                        if (isAuthenticated) {
                            // Log out
                            config.api_key = '';
                            config.account_name = '';
                            settingsChanged = true;
                            populateProviders();
                        } else {
                            // Initiate GitHub login
                            try {
                                const port = await getAgentPort();
                                const response = await fetch(`http://localhost:${port}/api/auth/github/device`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                const data = await response.json();

                                if (data.success) {
                                    // Show device code to user
                                    const code = data.user_code;
                                    alert(`Please enter this code at ${data.verification_uri}:\n\n${code}`);

                                    // Start polling for token
                                    pollForGitHubToken(data.device_code, data.interval);
                                }
                            } catch (err) {
                                console.error('GitHub auth initiation failed:', err);
                                alert('Failed to initiate GitHub login: ' + err.message);
                            }
                        }
                    }
                });
            });

            console.log('=== populateProviders() END ===');
        }

        function populateLayout() {
            document.getElementById('compactMode').checked = prefs.compact_mode || false;
            document.getElementById('alwaysOnTop').checked = prefs.always_on_top || false;
            document.getElementById('stayOpen').checked = prefs.stay_open || false;
            document.getElementById('showAll').checked = prefs.show_all !== false;
            document.getElementById('refreshInterval').value = prefs.refresh_interval || 300;
            document.getElementById('yellowThreshold').value = prefs.yellow_threshold || 60;
            document.getElementById('redThreshold').value = prefs.red_threshold || 80;
            document.getElementById('invertProgressBar').checked = prefs.invert_progress_bar || false;
            document.getElementById('autoUpdate').checked = prefs.auto_update !== false;
        }

        function populateFonts() {
            document.getElementById('fontFamily').value = prefs.font_family || '-apple-system';
            document.getElementById('fontSize').value = prefs.font_size || 13;
            document.getElementById('fontBold').checked = prefs.font_bold || false;
            document.getElementById('fontItalic').checked = prefs.font_italic || false;
        }

        function updateFontPreview() {
            const preview = document.getElementById('fontPreviewText');
            const family = document.getElementById('fontFamily').value;
            const size = document.getElementById('fontSize').value;
            const bold = document.getElementById('fontBold').checked;
            const italic = document.getElementById('fontItalic').checked;

            preview.style.fontFamily = family;
            preview.style.fontSize = size + 'px';
            preview.style.fontWeight = bold ? 'bold' : 'normal';
            preview.style.fontStyle = italic ? 'italic' : 'normal';
        }

        function resetFontSettings() {
            document.getElementById('fontFamily').value = '-apple-system';
            document.getElementById('fontSize').value = '13';
            document.getElementById('fontBold').checked = false;
            document.getElementById('fontItalic').checked = false;
            updateFontPreview();
            settingsChanged = true;
        }

        // Poll for GitHub token after device flow initiation
        async function pollForGitHubToken(deviceCode, interval) {
            const maxAttempts = 60; // 5 minutes with 5-second interval
            let attempts = 0;

            const pollInterval = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(pollInterval);
                    alert('GitHub login timed out. Please try again.');
                    return;
                }

                try {
                    const port = await getAgentPort();
                    const response = await fetch(`http://localhost:${port}/api/auth/github/poll`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device_code: deviceCode, interval: interval })
                    });
                    const data = await response.json();

                    if (data.success) {
                        clearInterval(pollInterval);
                        // Token received, update config
                        const config = configs.find(c => c.provider_id === 'github-copilot');
                        if (config) {
                            config.api_key = data.token;
                            config.auth_source = 'GitHub OAuth';
                            settingsChanged = true;
                            populateProviders();

                            // Fetch username
                            try {
                                const port = await getAgentPort();
                                const userResponse = await fetch(`http://localhost:${port}/api/auth/github/status`);
                                const userData = await userResponse.json();
                                if (userData.username) {
                                    config.account_name = userData.username;
                                    populateProviders();
                                }
                            } catch (err) {
                                console.error('Failed to fetch username:', err);
                            }

                            // Auto-save the config with the new token
                            if (invoke) {
                                await invoke('save_provider_configs', { configs });
                            }
                        }
                    } else if (data.status === 'expired' || data.status === 'access_denied') {
                        clearInterval(pollInterval);
                        alert('GitHub login failed: ' + (data.error || 'Unknown error'));
                    }
                    // If pending, continue polling
                } catch (err) {
                    console.error('GitHub token poll error:', err);
                }
            }, interval * 1000);
        }

        async function saveSettings() {
            try {
                document.querySelectorAll('.provider-card').forEach(card => {
                    const providerId = card.dataset.provider;
                    const config = configs.find(c => c.provider_id === providerId);
                    if (config) {
                        const trayCheckbox = card.querySelector('.tray-checkbox');
                        if (trayCheckbox) config.show_in_tray = trayCheckbox.checked;

                        const apiKeyInput = card.querySelector(`#api-key-${providerId}`);
                        if (apiKeyInput) config.api_key = apiKeyInput.value;

                        // Handle sub-tray checkboxes for antigravity
                        if (providerId === 'antigravity') {
                            const subTrayCheckboxes = card.querySelectorAll('.subtray-checkbox');
                            config.enabled_sub_trays = [];
                            subTrayCheckboxes.forEach(cb => {
                                if (cb.checked) {
                                    config.enabled_sub_trays.push(cb.dataset.detail);
                                }
                            });
                        }

                        // Auth source is read-only (displayed as label), so we don't change it here
                        // It shows where the config came from: Env, Config, Manual, or None
                    }
                });

                prefs.compact_mode = document.getElementById('compactMode').checked;
                prefs.always_on_top = document.getElementById('alwaysOnTop').checked;
                prefs.stay_open = document.getElementById('stayOpen').checked;
                prefs.show_all = document.getElementById('showAll').checked;
                prefs.refresh_interval = parseInt(document.getElementById('refreshInterval').value) || 300;
                prefs.yellow_threshold = parseInt(document.getElementById('yellowThreshold').value) || 60;
                prefs.red_threshold = parseInt(document.getElementById('redThreshold').value) || 80;
                prefs.invert_progress_bar = document.getElementById('invertProgressBar').checked;
                prefs.auto_update = document.getElementById('autoUpdate').checked;
                prefs.font_family = document.getElementById('fontFamily').value;
                prefs.font_size = parseInt(document.getElementById('fontSize').value) || 13;
                prefs.font_bold = document.getElementById('fontBold').checked;
                prefs.font_italic = document.getElementById('fontItalic').checked;

                if (invoke) {
                    await invoke('save_provider_configs', { configs });
                    await invoke('save_preferences', { preferences: prefs });

                    // Apply always on top setting
                    await invoke('toggle_always_on_top', { enabled: prefs.always_on_top });
                }

                settingsChanged = true;
                closeSettings();
            } catch (e) {
                console.error('Error saving:', e);
                alert('Failed to save settings: ' + e.message);
            }
        }

        async function scanForKeys() {
            const btn = document.getElementById('scanKeysBtn');
            btn.textContent = 'Scanning...';
            btn.disabled = true;

            try {
                if (invoke) {
                    const discovered = await invoke('scan_for_api_keys');

                    discovered.forEach(newConfig => {
                        const existing = configs.find(c => c.provider_id === newConfig.provider_id);
                        if (!existing) {
                            configs.push(newConfig);
                        } else if (!existing.api_key && newConfig.api_key) {
                            existing.api_key = newConfig.api_key;
                        }
                    });

                    populateProviders();
                    settingsChanged = true;
                }
            } catch (e) {
                console.error('Scan failed:', e);
            } finally {
                btn.textContent = 'Scan for Keys';
                btn.disabled = false;
            }
        }

        async function checkForUpdates() {
            const btn = document.getElementById('checkUpdatesBtn');
            const message = document.getElementById('updateMessage');

            btn.textContent = 'Checking...';
            btn.disabled = true;

            try {
                if (invoke) {
                    const result = await invoke('check_for_updates');
                    if (result.update_available) {
                        message.textContent = `Update available: ${result.latest_version}`;
                        message.style.color = 'var(--accent-green)';
                    } else {
                        message.textContent = 'You are running the latest version.';
                        message.style.color = 'var(--text-secondary)';
                    }
                }
            } catch (e) {
                message.textContent = 'Failed to check for updates.';
                message.style.color = 'var(--accent-red)';
            } finally {
                btn.textContent = 'Check for Updates';
                btn.disabled = false;
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('visible');
        }

        function closeSettings() {
            if (invoke) {
                invoke('close_settings_window');
            } else {
                window.close();
            }
        }
    </script>
</body>

</html>