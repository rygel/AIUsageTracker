name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.7.5)'
        required: true
        type: string
      skip_file_updates:
        description: 'Skip automatic file updates (use if files already updated)'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-files:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_file_updates }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update .csproj Files
        run: |
          version="${{ inputs.version }}"
          echo "Updating all .csproj files to $version"

          # Update AIConsumptionTracker.Core.csproj
          sed -i "s|<Version>.*</Version>|<Version>$version</Version>|g" AIConsumptionTracker.Core/AIConsumptionTracker.Core.csproj
          sed -i "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$version</AssemblyVersion>|g" AIConsumptionTracker.Core/AIConsumptionTracker.Core.csproj
          sed -i "s|<FileVersion>.*</FileVersion>|<FileVersion>$version</FileVersion>|g" AIConsumptionTracker.Core/AIConsumptionTracker.Core.csproj

          # Update AIConsumptionTracker.Infrastructure.csproj
          sed -i "s|<Version>.*</Version>|<Version>$version</Version>|g" AIConsumptionTracker.Infrastructure/AIConsumptionTracker.Infrastructure.csproj
          sed -i "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$version</AssemblyVersion>|g" AIConsumptionTracker.Infrastructure/AIConsumptionTracker.Infrastructure.csproj
          sed -i "s|<FileVersion>.*</FileVersion>|<FileVersion>$version</FileVersion>|g" AIConsumptionTracker.Infrastructure/AIConsumptionTracker.Infrastructure.csproj

          # Update AIConsumptionTracker.UI.csproj
          sed -i "s|<Version>.*</Version>|<Version>$version</Version>|g" AIConsumptionTracker.UI/AIConsumptionTracker.UI.csproj
          sed -i "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$version</AssemblyVersion>|g" AIConsumptionTracker.UI/AIConsumptionTracker.UI.csproj
          sed -i "s|<FileVersion>.*</FileVersion>|<FileVersion>$version</FileVersion>|g" AIConsumptionTracker.UI/AIConsumptionTracker.UI.csproj

          # Update AIConsumptionTracker.CLI.csproj
          sed -i "s|<Version>.*</Version>|<Version>$version</Version>|g" AIConsumptionTracker.CLI/AIConsumptionTracker.CLI.csproj
          sed -i "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$version</AssemblyVersion>|g" AIConsumptionTracker.CLI/AIConsumptionTracker.CLI.csproj
          sed -i "s|<FileVersion>.*</FileVersion>|<FileVersion>$version</FileVersion>|g" AIConsumptionTracker.CLI/AIConsumptionTracker.CLI.csproj

          echo "‚úì Updated all .csproj files to $version"

      - name: Update README.md Badge
        run: |
          version="${{ inputs.version }}"
          echo "Updating README.md version badge"
          sed -i "s|version-[0-9]\+\.[0-9]\+\.[0-9]\+-blue|version-$version-blue|g" README.md
          echo "‚úì Updated README.md badge to $version"

      - name: Update setup.iss
        run: |
          version="${{ inputs.version }}"
          echo "Updating setup.iss"
          sed -i "s|#define MyAppVersion \".*\"|#define MyAppVersion \"$version\"|g" scripts/setup.iss
          echo "‚úì Updated setup.iss to $version"

      - name: Update publish-app.ps1
        run: |
          version="${{ inputs.version }}"
          echo "Updating publish-app.ps1"
          sed -i "s|Version [0-9]\+\.[0-9]\+\.[0-9]\+|Version $version|g" scripts/publish-app.ps1
          sed -i "s|# Usage: .* -Runtime|# Usage: .\\scripts\\publish-app.ps1 -Runtime|g" scripts/publish-app.ps1
          sed -i "s|-Version [0-9]\+\.[0-9]\+\.[0-9]\+|-Version $version|g" scripts/publish-app.ps1
          echo "‚úì Updated publish-app.ps1 to $version"

      - name: Create Branch and Commit Changes
        id: create-branch
        run: |
          version="${{ inputs.version }}"
          branch_name="chore/release-v${version}-version-files"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add AIConsumptionTracker.Core/AIConsumptionTracker.Core.csproj
          git add AIConsumptionTracker.Infrastructure/AIConsumptionTracker.Infrastructure.csproj
          git add AIConsumptionTracker.UI/AIConsumptionTracker.UI.csproj
          git add AIConsumptionTracker.CLI/AIConsumptionTracker.CLI.csproj
          git add README.md
          git add scripts/setup.iss
          git add scripts/publish-app.ps1
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git checkout -b "$branch_name"
            git commit -m "chore(release): update version files to v$version"
            git push origin "$branch_name"
            echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úì Created branch and committed version updates"
          fi

      - name: Create Pull Request
        if: steps.create-branch.outputs.has_changes == 'true'
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ inputs.version }}"
          branch_name="${{ steps.create-branch.outputs.branch_name }}"
          
          pr_url=$(gh pr create \
            --title "chore(release): update version files to v$version" \
            --body "Automated version update for release v$version" \
            --base main \
            --head "$branch_name")
          
          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
          echo "‚úì Created PR: $pr_url"

      - name: Auto-merge Pull Request
        if: steps.create-branch.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_url="${{ steps.create-pr.outputs.pr_url }}"
          
          # Wait a moment for checks to start
          sleep 5
          
          # Enable auto-merge (squash) and merge immediately if possible
          gh pr merge "$pr_url" --squash --delete-branch --admin || \
          gh pr merge "$pr_url" --squash --delete-branch
          
          echo "‚úì Merged PR and deleted branch"
          
          # Wait for merge to complete on main
          sleep 3

  validate-and-release:
    runs-on: ubuntu-latest
    needs: update-files
    if: always()  # Always run this job, even if update-files is skipped
    outputs:
      all_valid: ${{ steps.set-all-valid.outputs.all_valid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Validate Version Format
        id: validate-version
        run: |
          version="${{ inputs.version }}"
          echo "Validating version: $version"

          if [[ "$version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "‚úì Version format is valid: $version"
            echo "version_valid=true" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Invalid version format. Use semantic versioning (e.g., 1.7.5)"
            echo "version_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check .csproj Files
        id: check-csproj
        run: |
          version="${{ inputs.version }}"
          version_valid=true
          versions_match=true

          for file in AIConsumptionTracker.Core/AIConsumptionTracker.Core.csproj \
                     AIConsumptionTracker.Infrastructure/AIConsumptionTracker.Infrastructure.csproj \
                     AIConsumptionTracker.UI/AIConsumptionTracker.UI.csproj \
                     AIConsumptionTracker.CLI/AIConsumptionTracker.CLI.csproj; do
            if [ ! -f "$file" ]; then
              echo "WARNING: File not found: $file"
              version_valid=false
              continue
            fi

            if grep -q "<Version>$version</Version>" "$file" && \
               grep -q "<AssemblyVersion>$version</AssemblyVersion>" "$file" && \
               grep -q "<FileVersion>$version</FileVersion>" "$file"; then
              echo "‚úì $file: $version"
            else
              version_valid=false
              versions_match=false
              echo "ERROR: $file has wrong version (check Version, AssemblyVersion, and FileVersion)"
            fi
          done

          echo "versions_match=$versions_match" >> $GITHUB_OUTPUT

      - name: Check CHANGELOG.md
        id: check-changelog
        run: |
          version="${{ inputs.version }}"
          changelog_valid=true

          if grep -q "## \[$version\]" CHANGELOG.md; then
            echo "‚úì CHANGELOG.md has version section for $version"
            echo "changelog_valid=true" >> $GITHUB_OUTPUT
          else
            echo "ERROR: CHANGELOG.md missing version section for $version"
            echo "Expected: '## [$version] - YYYY-MM-DD'"
            echo "changelog_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Check README.md
        id: check-readme
        run: |
          version="${{ inputs.version }}"
          readme_valid=true

          if grep -q "version-$version-blue" README.md; then
            echo "‚úì README.md has version badge for $version"
            echo "readme_valid=true" >> $GITHUB_OUTPUT
          else
            echo "ERROR: README.md version badge does not match $version"
            echo "Expected: 'version-$version-blue'"
            echo "readme_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Check scripts
        id: check-scripts
        run: |
          version="${{ inputs.version }}"
          scripts_valid=true

          if grep -q "MyAppVersion \"$version\"" scripts/setup.iss; then
            echo "‚úì setup.iss has version $version"
          else
            echo "ERROR: setup.iss version does not match $version"
            scripts_valid=false
          fi

          if grep -q "Version $version" scripts/publish-app.ps1; then
            echo "‚úì publish-app.ps1 has version $version"
          else
            echo "ERROR: publish-app.ps1 version does not match $version"
            scripts_valid=false
          fi

          echo "scripts_valid=$scripts_valid" >> $GITHUB_OUTPUT

      - name: Set All Valid Status
        id: set-all-valid
        run: |
          if [ "${{ steps.check-csproj.outputs.versions_match }}" == "true" ] && \
             [ "${{ steps.check-changelog.outputs.changelog_valid }}" == "true" ] && \
             [ "${{ steps.check-readme.outputs.readme_valid }}" == "true" ] && \
             [ "${{ steps.check-scripts.outputs.scripts_valid }}" == "true" ]; then
            all_valid=true
          else
            all_valid=false
          fi

          echo "all_valid=$all_valid" >> $GITHUB_OUTPUT

      - name: Validation Summary
        run: |
          echo "=== Validation Summary ==="
          echo "Version Format: ${{ steps.validate-version.outputs.version_valid }}"
          echo ".csproj Files: ${{ steps.check-csproj.outputs.versions_match }}"
          echo "CHANGELOG.md: ${{ steps.check-changelog.outputs.changelog_valid }}"
          echo "README.md: ${{ steps.check-readme.outputs.readme_valid }}"
          echo "Scripts: ${{ steps.check-scripts.outputs.scripts_valid }}"
          echo "All Valid: ${{ steps.set-all-valid.outputs.all_valid }}"

      - name: Generate Appcast File
        if: ${{ steps.set-all-valid.outputs.all_valid == 'true' }}
        run: |
          version="${{ inputs.version }}"
          version_number="${version#v}"
          pub_date=$(date -u '+%a, %d %b %Y %H:%M:%S %z')
          
          echo '<?xml version="1.0" encoding="UTF-8"?>' > appcast.xml
          echo '<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" version="2.0">' >> appcast.xml
          echo '    <channel>' >> appcast.xml
          echo '        <title>AI Consumption Tracker</title>' >> appcast.xml
          echo '        <link>https://github.com/rygel/AIConsumptionTracker/releases</link>' >> appcast.xml
          echo '        <description>Most recent changes with links to updates.</description>' >> appcast.xml
          echo '        <language>en</language>' >> appcast.xml
          echo '        <item>' >> appcast.xml
          echo "            <title>Version $version</title>" >> appcast.xml
          echo "            <sparkle:releaseNotesLink>https://github.com/rygel/AIConsumptionTracker/releases/tag/v$version_number</sparkle:releaseNotesLink>" >> appcast.xml
          echo "            <pubDate>$pub_date</pubDate>" >> appcast.xml
          echo "            <enclosure url=\"https://github.com/rygel/AIConsumptionTracker/releases/download/v$version_number/AIConsumptionTracker_Setup_v$version_number.exe\"" >> appcast.xml
          echo "                       sparkle:version=\"$version_number\"" >> appcast.xml
          echo '                       sparkle:os="windows"' >> appcast.xml
          echo '                       length="0"' >> appcast.xml
          echo '                       type="application/octet-stream" />' >> appcast.xml
          echo '        </item>' >> appcast.xml
          echo '    </channel>' >> appcast.xml
          echo '</rss>' >> appcast.xml
          echo "‚úì Generated appcast.xml"

      - name: Upload Appcast Artifact
        if: ${{ steps.set-all-valid.outputs.all_valid == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: appcast
          path: appcast.xml

      - name: Success
        if: ${{ steps.set-all-valid.outputs.all_valid == 'true' }}
        run: |
          echo "‚úÖ Validation passed for v${{ inputs.version }}"
          echo ""
          echo "üìã NEXT STEPS:"
          echo ""
          echo "1. Download appcast.xml from the workflow artifacts above"
          echo "2. Create and push the git tag manually:"
          echo "   git checkout main"
          echo "   git pull origin main"
          echo "   git tag v${{ inputs.version }}"
          echo "   git push origin v${{ inputs.version }}"
          echo ""
          echo "3. The tag push will automatically trigger the Publish workflow"
          echo "4. Upload appcast.xml to the release after it's created"

      - name: Failure
        if: ${{ steps.set-all-valid.outputs.all_valid != 'true' }}
        run: |
          echo "‚ùå Validation failed"
          echo "Please check the error messages above and ensure all version files match ${{ inputs.version }}"
          exit 1
