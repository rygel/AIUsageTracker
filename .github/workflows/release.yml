name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.7.5 or 1.7.5-alpha.2)'
        required: true
        type: string
      skip_file_updates:
        description: 'Skip automatic file updates (use if files already updated)'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-files:
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_file_updates }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update shared version source
        run: |
          version="${{ inputs.version }}"
          clean_version="${version%%-*}"
          echo "Updating shared version source to $version"
          sed -i "s|<TrackerVersion>.*</TrackerVersion>|<TrackerVersion>$version</TrackerVersion>|g" Directory.Build.props
          sed -i "s|<TrackerAssemblyVersion>.*</TrackerAssemblyVersion>|<TrackerAssemblyVersion>$clean_version</TrackerAssemblyVersion>|g" Directory.Build.props
          echo "‚úì Updated Directory.Build.props to $version (Assembly/FileVersion: $clean_version)"

      - name: Update README.md Badge
        run: |
          version="${{ inputs.version }}"
          escaped_version="${version//-/--}"
          echo "Updating README.md version badge"
          sed -i -E "s|!\[Version\]\(https://img\.shields\.io/badge/version-[^)]*\)|![Version](https://img.shields.io/badge/version-${escaped_version}-orange)|g" README.md
          echo "‚úì Updated README.md badge to $version"

      - name: Update setup.iss
        run: |
          version="${{ inputs.version }}"
          echo "Updating setup.iss"
          sed -i "s|#define MyAppVersion \".*\"|#define MyAppVersion \"$version\"|g" scripts/setup.iss
          echo "‚úì Updated setup.iss to $version"

      - name: Update publish-app.ps1
        run: |
          version="${{ inputs.version }}"
          echo "Updating publish-app.ps1"
          sed -i -E "s|Version [0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.]+)?|Version $version|g" scripts/publish-app.ps1
          sed -i "s|# Usage: .* -Runtime|# Usage: .\\scripts\\publish-app.ps1 -Runtime|g" scripts/publish-app.ps1
          sed -i -E "s|-Version [0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.]+)?|-Version $version|g" scripts/publish-app.ps1
          echo "‚úì Updated publish-app.ps1 to $version"

      - name: Create Branch and Commit Changes
        id: create-branch
        run: |
          version="${{ inputs.version }}"
          branch_name="chore/release-v${version}-version-files"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add Directory.Build.props
          git add README.md
          git add scripts/setup.iss
          git add scripts/publish-app.ps1
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git checkout -b "$branch_name"
            git commit -m "chore(release): update version files to v$version"
            git push origin "$branch_name"
            echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úì Created branch and committed version updates"
          fi

      - name: Create Pull Request
        if: steps.create-branch.outputs.has_changes == 'true'
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ inputs.version }}"
          branch_name="${{ steps.create-branch.outputs.branch_name }}"
          
          pr_url=$(gh pr create \
            --title "chore(release): update version files to v$version" \
            --body "Automated version update for release v$version" \
            --base main \
            --head "$branch_name")
          
          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
          echo "‚úì Created PR: $pr_url"

      - name: Auto-merge Pull Request
        if: steps.create-branch.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_url="${{ steps.create-pr.outputs.pr_url }}"
          
          # Wait a moment for checks to start
          sleep 5
          
          # Enable auto-merge (squash) and merge immediately if possible
          gh pr merge "$pr_url" --squash --delete-branch --admin || \
          gh pr merge "$pr_url" --squash --delete-branch
          
          echo "‚úì Merged PR and deleted branch"
          
          # Wait for merge to complete on main
          sleep 3

  validate-and-release:
    runs-on: ubuntu-latest
    needs: update-files
    if: always()  # Always run this job, even if update-files is skipped
    outputs:
      all_valid: ${{ steps.run-validation.outputs.all_valid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Run release consistency validation
        id: run-validation
        run: |
          version="${{ inputs.version }}"
          if bash scripts/validate-release-consistency.sh "$version"; then
            echo "all_valid=true" >> $GITHUB_OUTPUT
          else
            echo "all_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Validation Summary
        run: |
          echo "=== Validation Summary ==="
          echo "All Valid: ${{ steps.run-validation.outputs.all_valid }}"

      - name: Generate Appcast Files
        if: ${{ steps.run-validation.outputs.all_valid == 'true' }}
        run: |
          version="${{ inputs.version }}"
          bash scripts/generate-appcast.sh "$version"

      - name: Upload Appcast Artifacts
        if: ${{ steps.run-validation.outputs.all_valid == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: appcast-files
          path: |
            appcast.xml
            appcast_x64.xml
            appcast_arm64.xml
            appcast_x86.xml

      - name: Success
        if: ${{ steps.run-validation.outputs.all_valid == 'true' }}
        run: |
          echo "‚úÖ Validation passed for v${{ inputs.version }}"
          echo ""
          echo "üìã NEXT STEPS:"
          echo ""
          echo "1. Download all appcast files from the workflow artifacts above:"
          echo "   - appcast.xml (x64 - default)"
          echo "   - appcast_x64.xml"
          echo "   - appcast_arm64.xml"
          echo "   - appcast_x86.xml"
          echo ""
          echo "2. Create and push the git tag manually:"
          echo "   git checkout main"
          echo "   git pull origin main"
          echo "   git tag v${{ inputs.version }}"
          echo "   git push origin v${{ inputs.version }}"
          echo ""
          echo "3. The tag push will automatically trigger the Publish workflow"
          echo "4. Upload all 4 appcast files to the release after it's created"

      - name: Failure
        if: ${{ steps.run-validation.outputs.all_valid != 'true' }}
        run: |
          echo "‚ùå Validation failed"
          echo "Please check the error messages above and ensure all version files match ${{ inputs.version }}"
          exit 1
