@page
@model ReliabilityModel
@{
    ViewData["Title"] = "Provider Reliability";
}

<h1 class="page-title">Provider Reliability</h1>

<div hx-get="/reliability" hx-trigger="every 60s" hx-select="#reliability-content" hx-swap="innerHTML">
    <div id="reliability-content">
        @if (!Model.IsDatabaseAvailable)
        {
            <div class="alert alert-warning">
                <strong>Database not found!</strong> The Monitor database is not available. 
                Ensure the Monitor has run at least once to initialize the database.
            </div>
        }
        else if (Model.LatestUsage == null || Model.LatestUsage.Count == 0)
        {
            <div class="alert alert-info">
                No usage data available. The Monitor may still be collecting data.
            </div>
        }
        else
        {
            <div class="reliability-grid">
                @foreach (var usage in Model.LatestUsage)
                {
                    var hasReliability = Model.ReliabilityByProvider.TryGetValue(usage.ProviderId, out var reliability);
                    var snapshot = hasReliability && reliability != null
                        ? reliability
                        : AIUsageTracker.Core.Models.ProviderReliabilitySnapshot.Unavailable("No history");
                    var successRate = snapshot.IsAvailable
                        ? Math.Clamp(100 - snapshot.FailureRatePercent, 0, 100)
                        : 0;
                    var failureClass = snapshot.FailureRatePercent >= 20 ? "critical" : (snapshot.FailureRatePercent >= 5 ? "warning" : "success");
                    
                    <div class="reliability-card">
                        <div class="reliability-header">
                            <span class="provider-name">@usage.ProviderName</span>
                            <span class="reliability-badge @Model.GetReliabilityClass(snapshot)">
                                @Model.GetReliabilityLabel(snapshot)
                            </span>
                        </div>
                        
                        @if (snapshot.IsAvailable)
                        {
                            <div class="reliability-metric">
                                <div class="reliability-row">
                                    <span>Success Rate</span>
                                    <span>@successRate.ToString("F1")%</span>
                                </div>
                                <div class="reliability-progress">
                                    <div class="reliability-progress-bar success" style="width: @successRate%"></div>
                                </div>
                            </div>
                            
                            <div class="reliability-metric">
                                <div class="reliability-row">
                                    <span>Failure Rate</span>
                                    <span>@snapshot.FailureRatePercent.ToString("F1")%</span>
                                </div>
                                <div class="reliability-progress">
                                    <div class="reliability-progress-bar @failureClass" style="width: @snapshot.FailureRatePercent%"></div>
                                </div>
                            </div>
                            
                            <div class="reliability-row">
                                <span>Avg Latency</span>
                                <span>@Model.GetLatencyText(snapshot)</span>
                            </div>
                            <div class="reliability-row">
                                <span>Total Samples</span>
                                <span>@snapshot.SampleCount.ToString("N0")</span>
                            </div>
                            <div class="reliability-row">
                                <span>Success</span>
                                <span>@snapshot.SuccessCount.ToString("N0")</span>
                            </div>
                            <div class="reliability-row">
                                <span>Failures</span>
                                <span>@snapshot.FailureCount.ToString("N0")</span>
                            </div>
                            <div class="reliability-row">
                                <span>Last Sync</span>
                                <span>@Model.GetLastSyncText(snapshot)</span>
                            </div>
                        }
                        else
                        {
                            <div class="reliability-row">
                                <span>Status</span>
                                <span>@snapshot.Reason</span>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>
        }
        else if (Model.LatestUsage == null || Model.LatestUsage.Count == 0)
        {
            <div class="alert alert-info">
                No usage data available. The Monitor may still be collecting data.
            </div>
        }
        else
        {
            <div class="reliability-grid">
                @foreach (var usage in Model.LatestUsage)
                {
                    var hasReliability = Model.ReliabilityByProvider.TryGetValue(usage.ProviderId, out var reliability);
                    var snapshot = hasReliability && reliability != null
                        ? reliability
                        : AIUsageTracker.Core.Models.ProviderReliabilitySnapshot.Unavailable("No history");
                    var successRate = snapshot.IsAvailable
                        ? Math.Clamp(100 - snapshot.FailureRatePercent, 0, 100)
                        : 0;
                    var failureClass = snapshot.FailureRatePercent >= 20 ? "critical" : (snapshot.FailureRatePercent >= 5 ? "warning" : "success");
                    
                    <div class="reliability-card">
                        <div class="reliability-header">
                            <span class="provider-name">@usage.ProviderName</span>
                            <span class="reliability-badge @Model.GetReliabilityClass(snapshot)">
                                @Model.GetReliabilityLabel(snapshot)
                            </span>
                        </div>
                        
                        @if (snapshot.IsAvailable)
                        {
                            <div class="reliability-metric">
                                <div class="reliability-row">
                                    <span>Success Rate</span>
                                    <span>@successRate.ToString("F1")%</span>
                                </div>
                                <div class="reliability-progress">
                                    <div class="reliability-progress-bar success" style="width: @successRate%"></div>
                                </div>
                            </div>
                            
                            <div class="reliability-metric">
                                <div class="reliability-row">
                                    <span>Failure Rate</span>
                                    <span>@snapshot.FailureRatePercent.ToString("F1")%</span>
                                </div>
                                <div class="reliability-progress">
                                    <div class="reliability-progress-bar @failureClass" style="width: @snapshot.FailureRatePercent%"></div>
                                </div>
                            </div>
                            
                            <div class="reliability-row">
                                <span>Avg Latency</span>
                                <span>@Model.GetLatencyText(snapshot)</span>
                            </div>
                            <div class="reliability-row">
                                <span>Total Samples</span>
                                <span>@snapshot.SampleCount.ToString("N0")</span>
                            </div>
                            <div class="reliability-row">
                                <span>Success</span>
                                <span>@snapshot.SuccessCount.ToString("N0")</span>
                            </div>
                            <div class="reliability-row">
                                <span>Failures</span>
                                <span>@snapshot.FailureCount.ToString("N0")</span>
                            </div>
                            <div class="reliability-row">
                                <span>Last Sync</span>
                                <span>@Model.GetLastSyncText(snapshot)</span>
                            </div>
                        }
                        else
                        {
                            <div class="reliability-row">
                                <span>Status</span>
                                <span>@snapshot.Reason</span>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>
